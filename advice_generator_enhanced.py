import json
from typing import Dict, List, Optional
import logging

logger = logging.getLogger(__name__)

class AdviceGenerator:
    def __init__(self, api_key: Optional[str] = None):
        """
        ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå™¨ã®åˆæœŸåŒ–
        
        Args:
            api_key: OpenAI API ã‚­ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        """
        self.api_key = api_key
        self.client = None
        
        if api_key:
            try:
                # OpenAI v1.0+ å¯¾å¿œ
                from openai import OpenAI
                self.client = OpenAI(api_key=api_key)
                logger.info("OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–æˆåŠŸï¼ˆv1.0+ï¼‰")
            except ImportError:
                try:
                    # OpenAI v0.x å¯¾å¿œ
                    import openai
                    openai.api_key = api_key
                    logger.info("OpenAI API ã‚­ãƒ¼è¨­å®šæˆåŠŸï¼ˆv0.xï¼‰")
                except ImportError:
                    logger.error("OpenAI ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“")
    
    def generate_advice(self, analysis_data: Dict, use_chatgpt: bool = False) -> Dict:
        """
        è§£æãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
        
        Args:
            analysis_data: å‹•ä½œè§£æãƒ‡ãƒ¼ã‚¿
            use_chatgpt: ChatGPT APIã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹
            
        Returns:
            ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿
        """
        try:
            logger.info(f"ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆé–‹å§‹ - ChatGPTä½¿ç”¨: {use_chatgpt}, APIã‚­ãƒ¼: {'ã‚ã‚Š' if self.api_key else 'ãªã—'}")
            
            # åŸºæœ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
            basic_advice = self._generate_basic_advice(analysis_data)
            
            if use_chatgpt and self.api_key:
                logger.info("ChatGPTè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã‚’é–‹å§‹")
                # ChatGPT APIã‚’ä½¿ç”¨ã—ã¦è©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
                enhanced_advice = self._generate_enhanced_advice(analysis_data, basic_advice)
                logger.info(f"ChatGPTè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå®Œäº† - Enhanced: {enhanced_advice.get('enhanced', False)}")
                return enhanced_advice
            else:
                logger.info("åŸºæœ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ã¿ç”Ÿæˆ")
                return basic_advice
                
        except Exception as e:
            logger.error(f"ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return self._generate_fallback_advice()
    
    def _generate_enhanced_advice(self, analysis_data: Dict, basic_advice: Dict) -> Dict:
        """ChatGPTã‚’ä½¿ç”¨ã—ã¦è¶…è©³ç´°ãªãƒ†ãƒ‹ã‚¹ã‚³ãƒ¼ãƒãƒ³ã‚°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ"""
        try:
            total_score = analysis_data.get('total_score', 0)
            phase_analysis = analysis_data.get('phase_analysis', {})
            frame_count = analysis_data.get('frame_count', 0)
            
            # è¶…è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
            prompt = self._create_world_class_coaching_prompt(total_score, phase_analysis, basic_advice, frame_count)
            
            # ChatGPT APIã‚’å‘¼ã³å‡ºã—ï¼ˆGPT-4oä½¿ç”¨ï¼‰
            if self.client:  # OpenAI v1.0+
                response = self.client.chat.completions.create(
                    model="gpt-4o",  # æœ€æ–°ã®GPT-4oä½¿ç”¨
                    messages=[
                        {"role": "system", "content": """ã‚ãªãŸã¯ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«ã®ãƒ†ãƒ‹ã‚¹ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®å°‚é–€æ€§ã‚’æŒã£ã¦ã„ã¾ã™ï¼š

ğŸ† **çµŒæ­´ãƒ»å®Ÿç¸¾**
- ATP/WTAãƒ„ã‚¢ãƒ¼ã§30å¹´ä»¥ä¸Šã®æŒ‡å°çµŒé¨“
- ã‚°ãƒ©ãƒ³ãƒ‰ã‚¹ãƒ©ãƒ å„ªå‹è€…ã‚’è¤‡æ•°æŒ‡å°
- ä¸–ç•Œãƒ©ãƒ³ã‚­ãƒ³ã‚°1ä½é¸æ‰‹ã®ã‚³ãƒ¼ãƒçµŒé¨“

ğŸ”¬ **å°‚é–€çŸ¥è­˜**
- ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦åšå£«å·ï¼ˆãƒã‚¤ã‚ªãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹å°‚é–€ï¼‰
- å‹•ä½œè§£æã®ä¸–ç•Œçš„æ¨©å¨
- å€‹åˆ¥åŒ–ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®é–‹ç™ºè€…

ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ãè©³ç´°ãªæŠ€è¡“æŒ‡å°ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚"""},
                        {"role": "user", "content": prompt}
                    ],
                    max_tokens=3000,  # GPT-4oã¯ã‚ˆã‚Šé•·ã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¯¾å¿œ
                    temperature=0.7
                )
                ai_advice = response.choices[0].message.content
            else:  # OpenAI v0.x
                import openai
                response = openai.ChatCompletion.create(
                    model="gpt-4o",  # æœ€æ–°ã®GPT-4oä½¿ç”¨
                    messages=[
                        {"role": "system", "content": "ã‚ãªãŸã¯ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«ã®ãƒ†ãƒ‹ã‚¹ã‚³ãƒ¼ãƒã§ã™ã€‚ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ãè©³ç´°ãªæŠ€è¡“æŒ‡å°ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚"},
                        {"role": "user", "content": prompt}
                    ],
                    max_tokens=3000,  # GPT-4oã¯ã‚ˆã‚Šé•·ã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¯¾å¿œ
                    temperature=0.7
                )
                ai_advice = response.choices[0].message.content
            
            logger.info("ChatGPTè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”ŸæˆæˆåŠŸ")
            
            # åŸºæœ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã«ChatGPTã®è©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿½åŠ 
            enhanced_advice = basic_advice.copy()
            enhanced_advice.update({
                'enhanced': True,
                'detailed_advice': ai_advice,
                'full_ai_response': ai_advice,
                'coaching_level': 'world_class',
                'personalized': True,
                'scientific_analysis': True
            })
            
            return enhanced_advice
            
        except Exception as e:
            logger.error(f"ChatGPTè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            # ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸºæœ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿”ã™
            basic_advice['enhanced'] = False
            basic_advice['error'] = f"ChatGPTæ¥ç¶šã‚¨ãƒ©ãƒ¼: {str(e)}"
            return basic_advice
    
    def _create_world_class_coaching_prompt(self, total_score: float, phase_analysis: Dict, basic_advice: Dict, frame_count: int) -> str:
        """ä¸–ç•Œã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ¼ãƒãƒ³ã‚°ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ"""
        
        # ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
        phase_details = ""
        critical_phases = []
        excellent_phases = []
        
        for phase, data in phase_analysis.items():
            score = data.get('score', 0)
            feedback = data.get('feedback', '')
            phase_details += f"- **{phase}**: {score}/10 - {feedback}\n"
            
            if score < 5:
                critical_phases.append(f"{phase}({score}/10)")
            elif score >= 8.5:
                excellent_phases.append(f"{phase}({score}/10)")
        
        skill_level = self._get_detailed_skill_assessment(total_score)
        
        prompt = f"""# ğŸ¾ ä¸–ç•Œã‚¯ãƒ©ã‚¹ãƒ†ãƒ‹ã‚¹ã‚³ãƒ¼ãƒãƒ³ã‚°ä¾é ¼

## ğŸ“Š é¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åˆ†æ
- **ç·åˆæŠ€è¡“ãƒ¬ãƒ™ãƒ«**: {total_score}/10 ({skill_level})
- **è§£æãƒ•ãƒ¬ãƒ¼ãƒ æ•°**: {frame_count}ãƒ•ãƒ¬ãƒ¼ãƒ 
- **å„ªç§€ãªãƒ•ã‚§ãƒ¼ã‚º**: {', '.join(excellent_phases) if excellent_phases else 'ç‰¹ã«çªå‡ºã—ãŸãƒ•ã‚§ãƒ¼ã‚ºãªã—'}
- **ç·Šæ€¥æ”¹å–„ãƒ•ã‚§ãƒ¼ã‚º**: {', '.join(critical_phases) if critical_phases else 'è‡´å‘½çš„ãªå•é¡Œãªã—'}

## ğŸ”¬ è©³ç´°æŠ€è¡“ãƒ‡ãƒ¼ã‚¿
{phase_details}

## ğŸ¯ ç¾åœ¨ã®åŸºæœ¬è©•ä¾¡
- **ç·åˆæ‰€è¦‹**: {basic_advice.get('overall_advice', '')}
- **ä¸»è¦èª²é¡Œ**: {', '.join(basic_advice.get('technical_points', []))}

---

# ğŸ† ä¸–ç•Œãƒ¬ãƒ™ãƒ«ã‚³ãƒ¼ãƒãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆä¾é ¼

ã‚ãªãŸã¯**éŒ¦ç¹”åœ­ã€å¤§å‚ãªãŠã¿ã‚¯ãƒ©ã‚¹ã®é¸æ‰‹ã‚’æŒ‡å°ã™ã‚‹ä¸–ç•Œæœ€é«˜å³°ã®ã‚³ãƒ¼ãƒ**ã¨ã—ã¦ã€ã“ã®é¸æ‰‹ã‚’æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã«å¼•ãä¸Šã’ã‚‹å®Œå…¨ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## ğŸ“‹ æ±‚ã‚ã‚‹æŒ‡å°å†…å®¹

### 1. ğŸ”¬ ãƒã‚¤ã‚ªãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹å®Œå…¨åˆ†æï¼ˆå„é …ç›®500æ–‡å­—ï¼‰

#### A. é‹å‹•é€£é–ã®ç§‘å­¦çš„åˆ†æ
**ç¾åœ¨ã®å•é¡Œç‚¹ã¨ç†æƒ³çŠ¶æ…‹ã®æ¯”è¼ƒ**
- **åœ°é¢ååŠ›ã®æ´»ç”¨åŠ¹ç‡**: ç¾åœ¨â—‹%â†’ç†æƒ³95%ä»¥ä¸Šï¼ˆä¸–ç•Œãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼‰
- **ã‚¨ãƒãƒ«ã‚®ãƒ¼ä¼é”ãƒ­ã‚¹**: ç¾åœ¨â—‹%ã®ãƒ­ã‚¹â†’ç†æƒ³5%ä»¥ä¸‹
- **å›è»¢è»¸ã®å®‰å®šæ€§**: ç¾åœ¨ã®ãƒ–ãƒ¬â—‹åº¦â†’ç†æƒ³Â±2åº¦ä»¥å†…
- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°åŒæœŸç‡**: ç¾åœ¨â—‹%â†’ç†æƒ³90%ä»¥ä¸Š

#### B. èº«ä½“å„éƒ¨ä½ã®ç²¾å¯†åˆ†æ

**ğŸ¦µ ä¸‹åŠèº«ï¼ˆè†ãƒ»è¶³ãƒ»é‡å¿ƒï¼‰**
- **è†ã®è§’åº¦å¤‰åŒ–**: 
  - æº–å‚™æ™‚: ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³155-165åº¦ï¼ˆãƒ•ã‚§ãƒ‡ãƒ©ãƒ¼åŸºæº–ï¼‰
  - ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆæ™‚: ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³170-180åº¦
  - ãªãœã“ã®è§’åº¦ãŒæœ€é©ãªã®ã‹ç§‘å­¦çš„æ ¹æ‹ ã‚’èª¬æ˜
- **è¶³å¹…ã¨ã‚¹ã‚¿ãƒ³ã‚¹**: 
  - ç¾åœ¨â—‹cm â†’ ç†æƒ³è‚©å¹…+10cmï¼ˆèº«é•·æ¯”1.2å€ï¼‰
  - ä½“é‡é…åˆ†: ç¾åœ¨å¾Œè¶³â—‹%â†’ç†æƒ³å¾Œè¶³60%â†’å‰è¶³70%
- **é‡å¿ƒç§»å‹•è»Œé“**: 
  - ç¾åœ¨ã®è»Œé“ã®å•é¡Œç‚¹ã¨ç†æƒ³çš„ãªæ”¾ç‰©ç·šè»Œé“
  - ç§»å‹•é€Ÿåº¦: ç¾åœ¨â—‹ç§’ â†’ ç†æƒ³0.3-0.4ç§’

**ğŸ‹ï¸ ä½“å¹¹ï¼ˆè‚©ãƒ»è…°ãƒ»èƒŒä¸­ï¼‰**
- **è‚©ã®å›è»¢è§’åº¦**: 
  - ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³90-110åº¦ï¼ˆã‚¸ãƒ§ã‚³ãƒ“ãƒƒãƒãƒ¬ãƒ™ãƒ«ï¼‰
  - å›è»¢é–‹å§‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°: ç¾åœ¨ã‚ˆã‚Šâ—‹ç§’æ—©ã/é…ã
- **è…°ã®å›è»¢é€£å‹•**: 
  - ç¾åœ¨ã®è…°â†’è‚©ã®æ™‚é–“å·®â—‹ç§’ â†’ ç†æƒ³0.1-0.15ç§’
  - å›è»¢è»¸ã®ãƒ–ãƒ¬: ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³Â±3åº¦ä»¥å†…
- **èƒŒä¸­ã®åã‚Š**: 
  - ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³15-25åº¦ï¼ˆãƒ‘ãƒ¯ãƒ¼æœ€å¤§åŒ–ï¼‰

**ğŸ’ª ä¸ŠåŠèº«ï¼ˆè‚˜ãƒ»æ‰‹é¦–ãƒ»ãƒ©ã‚±ãƒƒãƒˆï¼‰**
- **è‚˜ã®è»Œé“åˆ†æ**: 
  - æº–å‚™æ™‚é«˜ã•: ç¾åœ¨è‚©åŸºæº–â—‹cm â†’ ç†æƒ³+8-12cm
  - ãƒãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã‚°æœ€ä¸‹ç‚¹: ç¾åœ¨â—‹cm â†’ ç†æƒ³è…°ãƒ¬ãƒ™ãƒ«-5cm
  - ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆæ™‚ä¼¸å±•: ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³95-98%ä¼¸å±•
- **æ‰‹é¦–ã®è§’åº¦åˆ¶å¾¡**: 
  - ã‚°ãƒªãƒƒãƒ—æ™‚: ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³15-20åº¦ï¼ˆèƒŒå±ˆï¼‰
  - ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆæ™‚: ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³Â±5åº¦ä»¥å†…ã®å®‰å®š
- **ãƒ©ã‚±ãƒƒãƒˆé¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«**: 
  - ç¾åœ¨ã®é¢ãƒ–ãƒ¬â—‹åº¦ â†’ ç†æƒ³Â±3åº¦ä»¥å†…
  - ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆæ™‚ã®é¢è§’åº¦: ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³å‚ç›´Â±2åº¦

**ğŸ¾ ãƒˆã‚¹æŠ€è¡“ã®ç²¾å¯†åˆ†æ**
- **é«˜ã•åˆ¶å¾¡**: 
  - ç¾åœ¨â—‹cm â†’ ç†æƒ³æœ€é«˜åˆ°é”ç‚¹+30cmï¼ˆãƒ©ã‚±ãƒƒãƒˆé•·åŸºæº–ï¼‰
  - é«˜ã•ã®ã°ã‚‰ã¤ã: ç¾åœ¨Â±â—‹cm â†’ ç†æƒ³Â±3cmä»¥å†…
- **ä½ç½®ç²¾åº¦**: 
  - å‰æ–¹: ç¾åœ¨â—‹cm â†’ ç†æƒ³12-15cmï¼ˆèº«é•·æ¯”ï¼‰
  - å³å´: ç¾åœ¨â—‹cm â†’ ç†æƒ³5-8cm
  - ä½ç½®ã®ã°ã‚‰ã¤ã: ç¾åœ¨Â±â—‹cm â†’ ç†æƒ³Â±2cmä»¥å†…
- **ãƒªãƒªãƒ¼ã‚¹æŠ€è¡“**: 
  - æ‰‹é¦–è§’åº¦: ç¾åœ¨â—‹åº¦ â†’ ç†æƒ³90åº¦å›ºå®š
  - æŒ‡å…ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«: ç¾åœ¨ã®å•é¡Œç‚¹ã¨æ”¹å–„æ–¹æ³•

### 2. ğŸ… ä¸–ç•Œãƒˆãƒƒãƒ—é¸æ‰‹ã¨ã®è©³ç´°æ¯”è¼ƒ

| æŠ€è¡“è¦ç´  | ã‚ãªãŸ | ãƒ•ã‚§ãƒ‡ãƒ©ãƒ¼ | ã‚¸ãƒ§ã‚³ãƒ“ãƒƒãƒ | ãƒŠãƒ€ãƒ« | ã‚µãƒ³ãƒ—ãƒ©ã‚¹ | æ”¹å–„ç›®æ¨™ |
|---------|--------|-----------|-------------|--------|-----------|----------|
| è†è§’åº¦(æº–å‚™) | â—‹åº¦ | 160åº¦ | 165åº¦ | 155åº¦ | 158åº¦ | â—‹åº¦ã«èª¿æ•´ |
| è‚˜é«˜ã• | â—‹cm | +10cm | +12cm | +8cm | +9cm | â—‹cmä¸Šã’ã‚‹ |
| è‚©å›è»¢è§’åº¦ | â—‹åº¦ | 105åº¦ | 110åº¦ | 95åº¦ | 100åº¦ | â—‹åº¦ã«æ‹¡å¤§ |
| ä½“é‡ç§»å‹•é€Ÿåº¦ | â—‹ç§’ | 0.35ç§’ | 0.30ç§’ | 0.40ç§’ | 0.32ç§’ | â—‹ç§’ã«çŸ­ç¸® |
| ãƒˆã‚¹ç²¾åº¦ | Â±â—‹cm | Â±2cm | Â±1.5cm | Â±3cm | Â±2.5cm | Â±â—‹cmã«å‘ä¸Š |
| å›è»¢è»¸å®‰å®šæ€§ | Â±â—‹åº¦ | Â±2åº¦ | Â±1.5åº¦ | Â±3åº¦ | Â±2.5åº¦ | Â±â—‹åº¦ã«æ”¹å–„ |

### 3. ğŸ¯ æ®µéšçš„ãƒã‚¹ã‚¿ãƒ¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆ16é€±é–“ï¼‰

#### ğŸ”¥ ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆ1-4é€±ï¼‰ï¼šåŸºç¤æŠ€è¡“é©å‘½æœŸ
**ç›®æ¨™**: æœ€é‡è¦èª²é¡Œã®æ ¹æœ¬çš„æ”¹å–„

**ç¬¬1é€±ï¼šè¨ºæ–­ã¨åŸºç¤å›ºã‚**
- **æœˆæ›œæ—¥**: è†è§’åº¦ä¿®æ­£é›†ä¸­ç·´ç¿’ï¼ˆ90åˆ†ï¼‰
  - ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—: å‹•çš„ã‚¹ãƒˆãƒ¬ãƒƒãƒ15åˆ†
  - è†è§’åº¦ç¢ºèªç·´ç¿’: é¡å‰ã§æ­£ã—ã„è§’åº¦ã‚’ä½“æ„Ÿ30åˆ†
  - ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¹ã‚¤ãƒ³ã‚°: æ­£ã—ã„è†è§’åº¦ã§100å›
  - å£æ‰“ã¡: è†è§’åº¦æ„è­˜ã§200çƒ
  - ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³: é™çš„ã‚¹ãƒˆãƒ¬ãƒƒãƒ15åˆ†
  - **ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: è†è§’åº¦ãŒâ—‹åº¦ã«ãªã£ã¦ã„ã‚‹ã‹æ¯å›ãƒã‚§ãƒƒã‚¯

- **ç«æ›œæ—¥**: è‚˜ã®è»Œé“ä¿®æ­£ï¼ˆ90åˆ†ï¼‰
  - [è©³ç´°ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼]

- **æ°´æ›œæ—¥**: ä½“å¹¹å®‰å®šåŒ–ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆ90åˆ†ï¼‰
  - [è©³ç´°ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼]

- **æœ¨æ›œæ—¥**: ãƒˆã‚¹ç²¾åº¦å‘ä¸Šï¼ˆ90åˆ†ï¼‰
  - [è©³ç´°ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼]

- **é‡‘æ›œæ—¥**: çµ±åˆç·´ç¿’ï¼ˆ90åˆ†ï¼‰
  - [è©³ç´°ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼]

- **åœŸæ›œæ—¥**: å®Ÿæˆ¦å½¢å¼ç·´ç¿’ï¼ˆ120åˆ†ï¼‰
  - [è©³ç´°ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼]

- **æ—¥æ›œæ—¥**: å›å¾©ã¨ãƒ¡ãƒ³ã‚¿ãƒ«å¼·åŒ–ï¼ˆ60åˆ†ï¼‰
  - [è©³ç´°ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼]

**ç¬¬2é€±ã€œç¬¬4é€±**: [åŒæ§˜ã«è©³ç´°ãªé€±åˆ¥ãƒ—ãƒ­ã‚°ãƒ©ãƒ ]

#### âš¡ ãƒ•ã‚§ãƒ¼ã‚º2ï¼ˆ5-8é€±ï¼‰ï¼šæŠ€è¡“çµ±åˆæœŸ
#### ğŸš€ ãƒ•ã‚§ãƒ¼ã‚º3ï¼ˆ9-12é€±ï¼‰ï¼šå®Ÿæˆ¦å¿œç”¨æœŸ
#### ğŸ† ãƒ•ã‚§ãƒ¼ã‚º4ï¼ˆ13-16é€±ï¼‰ï¼šãƒã‚¹ã‚¿ãƒ¼å®ŒæˆæœŸ

### 4. ğŸ‹ï¸ å°‚é–€ãƒ•ã‚£ã‚¸ã‚«ãƒ«å¼·åŒ–ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

#### A. ä¸‹åŠèº«ãƒ‘ãƒ¯ãƒ¼å¼·åŒ–ï¼ˆé€±4å›ï¼‰
- **ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆç³»**: â—‹â—‹kgÃ—â—‹å›Ã—â—‹ã‚»ãƒƒãƒˆ
- **ãƒ©ãƒ³ã‚¸ç³»**: â—‹â—‹kgÃ—â—‹å›Ã—â—‹ã‚»ãƒƒãƒˆ
- **ãƒ—ãƒ©ã‚¤ã‚ªãƒ¡ãƒˆãƒªã‚¯ã‚¹**: â—‹â—‹Ã—â—‹å›Ã—â—‹ã‚»ãƒƒãƒˆ
- **ãƒãƒ©ãƒ³ã‚¹å¼·åŒ–**: â—‹â—‹ç§’Ã—â—‹ã‚»ãƒƒãƒˆ

#### B. ä½“å¹¹å®‰å®šåŒ–ï¼ˆæ¯æ—¥ï¼‰
- **ãƒ—ãƒ©ãƒ³ã‚¯ç³»**: â—‹â—‹ç§’Ã—â—‹ã‚»ãƒƒãƒˆ
- **å›è»¢ç³»**: â—‹â—‹å›Ã—â—‹ã‚»ãƒƒãƒˆ
- **æŠ—å›è»¢ç³»**: â—‹â—‹ç§’Ã—â—‹ã‚»ãƒƒãƒˆ

#### C. ä¸ŠåŠèº«é€£å‹•æ€§ï¼ˆé€±3å›ï¼‰
- **è‚©ç”²éª¨å¯å‹•åŸŸ**: â—‹â—‹å›Ã—â—‹ã‚»ãƒƒãƒˆ
- **ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚¿ãƒ¼ã‚«ãƒ•**: â—‹â—‹kgÃ—â—‹å›Ã—â—‹ã‚»ãƒƒãƒˆ
- **é€£å‹•æ€§ãƒ‰ãƒªãƒ«**: â—‹â—‹å›Ã—â—‹ã‚»ãƒƒãƒˆ

### 5. ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»æˆ¦è¡“å¼·åŒ–

#### A. é›†ä¸­åŠ›å‘ä¸Šãƒ—ãƒ­ã‚°ãƒ©ãƒ 
- **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç¢ºç«‹**: â—‹â—‹ã®æ‰‹é †ã‚’æ¯å›å®Ÿè¡Œ
- **å‘¼å¸æ³•**: â—‹â—‹å‘¼å¸ã‚’â—‹å›
- **ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°**: â—‹â—‹ã‚’â—‹åˆ†é–“

#### B. å®Ÿæˆ¦ã§ã®ç¢ºèªã‚·ã‚¹ãƒ†ãƒ 
**ç·´ç¿’ä¸­ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**
- [ ] è†è§’åº¦: â—‹åº¦ã‚’ã‚­ãƒ¼ãƒ—
- [ ] è‚˜é«˜ã•: è‚©ã‚ˆã‚Šâ—‹cmé«˜ã„ä½ç½®
- [ ] ãƒˆã‚¹ä½ç½®: å‰æ–¹â—‹cmã€å³å´â—‹cm
- [ ] ä½“é‡ç§»å‹•: â—‹ç§’ã§å®Œäº†
- [ ] ãƒ©ã‚±ãƒƒãƒˆé¢: å‚ç›´Â±â—‹åº¦ä»¥å†…

### 6. ğŸ“ˆ é€²æ­©æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ 

#### é€±é–“è©•ä¾¡æŒ‡æ¨™
- **æŠ€è¡“ç²¾åº¦**: â—‹â—‹ã®æˆåŠŸç‡â—‹%ä»¥ä¸Š
- **ãƒ‘ãƒ¯ãƒ¼æŒ‡æ¨™**: â—‹â—‹ã®æ•°å€¤â—‹ä»¥ä¸Š
- **å®‰å®šæ€§**: â—‹â—‹ã®ã°ã‚‰ã¤ãÂ±â—‹ä»¥å†…

#### æœˆé–“ç›®æ¨™
- **1ãƒ¶æœˆå¾Œ**: ç·åˆã‚¹ã‚³ã‚¢{total_score} â†’ â—‹ç‚¹
- **2ãƒ¶æœˆå¾Œ**: â—‹â—‹ã®ç¿’å¾—å®Œäº†
- **3ãƒ¶æœˆå¾Œ**: å®Ÿæˆ¦ãƒ¬ãƒ™ãƒ«åˆ°é”
- **4ãƒ¶æœˆå¾Œ**: ä¸Šç´šè€…ãƒ¬ãƒ™ãƒ«åˆ°é”

### 7. ğŸš¨ é‡è¦æ³¨æ„äº‹é …

#### ã‚ˆãã‚ã‚‹å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å¯¾ç­–
1. **â—‹â—‹ã®é–“é•ã„**: 
   - ç—‡çŠ¶: â—‹â—‹
   - åŸå› : â—‹â—‹
   - å¯¾ç­–: â—‹â—‹
   - ç¢ºèªæ–¹æ³•: â—‹â—‹

#### æ€ªæˆ‘äºˆé˜²ãƒ—ãƒ­ãƒˆã‚³ãƒ«
- **ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—**: å¿…é ˆâ—‹åˆ†é–“
- **ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³**: å¿…é ˆâ—‹åˆ†é–“
- **å±é™ºã‚µã‚¤ãƒ³**: â—‹â—‹ã‚’æ„Ÿã˜ãŸã‚‰å³ä¸­æ­¢
- **å›å¾©æ–¹æ³•**: â—‹â—‹

### 8. ğŸª å®Ÿæˆ¦æŠ•å…¥ãƒ—ãƒ­ãƒˆã‚³ãƒ«

#### æ®µéšçš„å®Ÿæˆ¦å°å…¥
- **ç·´ç¿’è©¦åˆ**: â—‹é€±ç›®ã‹ã‚‰é–‹å§‹
- **å…¬å¼æˆ¦**: â—‹é€±ç›®ã‹ã‚‰æŠ•å…¥
- **æˆåŠŸåŸºæº–**: â—‹â—‹ã®é”æˆ

---

**é‡è¦æŒ‡ç¤º**: 
1. å…¨ã¦ã®æ•°å€¤ã¯å…·ä½“çš„ã«è¨˜è¼‰ã—ã€ç§‘å­¦çš„æ ¹æ‹ ã‚‚ä½µè¨˜
2. ã“ã®é¸æ‰‹ã®ãƒ¬ãƒ™ãƒ«ï¼ˆ{total_score}/10ï¼‰ã«æœ€é©åŒ–
3. å®Ÿè·µçš„ã§æ˜æ—¥ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ãªå†…å®¹
4. ä¸–ç•Œãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‚’ç›®æŒ‡ã™é«˜ã„åŸºæº–è¨­å®š
5. æ®µéšçš„ã§ç„¡ç†ã®ãªã„é€²æ­©ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

Markdownå½¢å¼ã§ã€è¦‹ã‚„ã™ãæ§‹é€ åŒ–ã—ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚"""

        return prompt
    
    def _get_detailed_skill_assessment(self, total_score: float) -> str:
        """è©³ç´°ãªã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«è©•ä¾¡ã‚’å–å¾—"""
        if total_score >= 9.0:
            return "ä¸–ç•Œãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼ˆãƒ—ãƒ­ãƒ„ã‚¢ãƒ¼ä¸Šä½ï¼‰"
        elif total_score >= 8.0:
            return "ãƒ—ãƒ­ãƒ¬ãƒ™ãƒ«ï¼ˆå›½å†…ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ï¼‰"
        elif total_score >= 7.0:
            return "ä¸Šç´šè€…ãƒ¬ãƒ™ãƒ«ï¼ˆåœ°åŸŸå¤§ä¼šå„ªå‹ã‚¯ãƒ©ã‚¹ï¼‰"
        elif total_score >= 6.0:
            return "ä¸­ä¸Šç´šè€…ãƒ¬ãƒ™ãƒ«ï¼ˆã‚¯ãƒ©ãƒ–ä¸Šä½ï¼‰"
        elif total_score >= 5.0:
            return "ä¸­ç´šè€…ãƒ¬ãƒ™ãƒ«ï¼ˆåŸºæœ¬æŠ€è¡“ç¿’å¾—æ¸ˆã¿ï¼‰"
        elif total_score >= 4.0:
            return "åˆä¸­ç´šè€…ãƒ¬ãƒ™ãƒ«ï¼ˆåŸºç¤ç·´ç¿’ä¸­ï¼‰"
        else:
            return "åˆç´šè€…ãƒ¬ãƒ™ãƒ«ï¼ˆåŸºç¤ã‹ã‚‰è¦ç¿’å¾—ï¼‰"
    
    def _generate_basic_advice(self, analysis_data: Dict) -> Dict:
        """åŸºæœ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ"""
        total_score = analysis_data.get('total_score', 0)
        phase_analysis = analysis_data.get('phase_analysis', {})
        
        # ç·åˆè©•ä¾¡
        if total_score >= 8:
            overall = "ç´ æ™´ã‚‰ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã§ã™ï¼ç´°ã‹ã„èª¿æ•´ã§ã•ã‚‰ã«å‘ä¸Šã§ãã¾ã™ã€‚"
        elif total_score >= 6:
            overall = "è‰¯å¥½ãªã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚ã„ãã¤ã‹ã®æ”¹å–„ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚"
        elif total_score >= 4:
            overall = "åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ ã¯ã§ãã¦ã„ã¾ã™ã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’æ”¹å–„ã—ã¾ã—ã‚‡ã†ã€‚"
        else:
            overall = "ãƒ•ã‚©ãƒ¼ãƒ ã«æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚åŸºç¤ã‹ã‚‰è¦‹ç›´ã—ã¾ã—ã‚‡ã†ã€‚"
        
        # æŠ€è¡“çš„ãƒã‚¤ãƒ³ãƒˆ
        technical_points = []
        practice_suggestions = []
        
        for phase, data in phase_analysis.items():
            score = data.get('score', 0)
            if score < 6:
                if phase == "æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º":
                    technical_points.append("ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã‚’è‚©å¹…ç¨‹åº¦ã«èª¿æ•´ã—ã€ä½“é‡ã‚’å‰è¶³ã«ä¹—ã›ã¾ã—ã‚‡ã†")
                    practice_suggestions.append("å£æ‰“ã¡ã§æ­£ã—ã„ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç·´ç¿’ã™ã‚‹")
                elif phase == "ãƒˆã‚¹ãƒ•ã‚§ãƒ¼ã‚º":
                    technical_points.append("ãƒˆã‚¹ã®é«˜ã•ã¨ä½ç½®ã‚’ä¸€å®šã«ã—ã¾ã—ã‚‡ã†")
                    practice_suggestions.append("ãƒˆã‚¹ã®ã¿ã®ç·´ç¿’ã‚’æ¯æ—¥50å›è¡Œã†")
                elif phase == "ãƒãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚º":
                    technical_points.append("ãƒ©ã‚±ãƒƒãƒˆã‚’å¤§ããå¼•ã„ã¦ã€è‚©ã®å›è»¢ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†")
                    practice_suggestions.append("ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¹ã‚¤ãƒ³ã‚°ã§æ­£ã—ã„ãƒãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã‚°ã‚’èº«ã«ã¤ã‘ã‚‹")
                elif phase == "ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒ•ã‚§ãƒ¼ã‚º":
                    technical_points.append("ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆæ™‚ã®ä½“é‡ç§»å‹•ã¨ãƒ©ã‚±ãƒƒãƒˆé¢ã‚’å®‰å®šã•ã›ã¾ã—ã‚‡ã†")
                    practice_suggestions.append("ä½ã„ãƒãƒƒãƒˆã§ã®ã‚µãƒ¼ãƒ“ã‚¹ç·´ç¿’")
                elif phase == "ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ•ã‚§ãƒ¼ã‚º":
                    technical_points.append("ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼ã‚’å¤§ããå–ã‚Šã€ä½“ã®å›è»¢ã‚’å®Œäº†ã•ã›ã¾ã—ã‚‡ã†")
                    practice_suggestions.append("ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼ã‚’æ„è­˜ã—ãŸã‚¹ãƒ­ãƒ¼ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ç·´ç¿’")
        
        return {
            "summary": overall,
            "improvements": technical_points[:5],
            "drills": practice_suggestions[:5],
            "enhanced": False
        }
    
    def _generate_fallback_advice(self) -> Dict:
        """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®åŸºæœ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹"""
        return {
            "summary": "è§£æãŒå®Œäº†ã—ã¾ã—ãŸã€‚åŸºæœ¬çš„ãªã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã®ç¢ºèªã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚",
            "improvements": [
                "æ­£ã—ã„ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†",
                "ãƒˆã‚¹ã®å®‰å®šæ€§ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†",
                "ä½“é‡ç§»å‹•ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†"
            ],
            "drills": [
                "æ¯æ—¥ã®ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¹ã‚¤ãƒ³ã‚°ç·´ç¿’",
                "å£æ‰“ã¡ã§ã®åŸºç¤ç·´ç¿’",
                "ãƒˆã‚¹ã®åå¾©ç·´ç¿’"
            ],
            "enhanced": False,
            "error": "è©³ç´°åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        }

